{"title":"攻防世界 -pwn-stack2","slug":"攻防世界-pwn-stack2","date":"2020-07-27","updated":"2020-07-31","comments":true,"path":"api/posts/14181.json","excerpt":null,"cover":"https://i.loli.net/2020/07/27/seUw8f5zIvPk9W7.png","covers":["https://i.loli.net/2020/07/27/seUw8f5zIvPk9W7.png","https://i.loli.net/2020/07/31/ClcWPX8p29JHxQk.png","https://i.loli.net/2020/07/31/j24baYfNMdlRrGD.png"],"content":"<h2 id=\"0x01- 分析\"><a href=\"#0x01- 分析\" class=\"headerlink\" title=\"0x01 分析\"></a>0x01 分析 </h2><p>checksec 检查：</p>\n<p><img src=\"https://i.loli.net/2020/07/27/seUw8f5zIvPk9W7.png\" alt=\"捕获.PNG\"></p>\n<p>32 位，无 PIE，开了 NX 和 canary.<br> 运行一下是只有五个模块，展示数字，添加，更改，求平均数，退出。</p>\n<p>IDA 中查看 main 函数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  int v3; &#x2F;&#x2F; eax</span><br><span class=\"line\">  unsigned int v5; &#x2F;&#x2F; [esp+18h] [ebp-90h]</span><br><span class=\"line\">  unsigned int v6; &#x2F;&#x2F; [esp+1Ch] [ebp-8Ch]</span><br><span class=\"line\">  int v7; &#x2F;&#x2F; [esp+20h] [ebp-88h]</span><br><span class=\"line\">  unsigned int j; &#x2F;&#x2F; [esp+24h] [ebp-84h]</span><br><span class=\"line\">  int v9; &#x2F;&#x2F; [esp+28h] [ebp-80h]</span><br><span class=\"line\">  unsigned int i; &#x2F;&#x2F; [esp+2Ch] [ebp-7Ch]</span><br><span class=\"line\">  unsigned int k; &#x2F;&#x2F; [esp+30h] [ebp-78h]</span><br><span class=\"line\">  unsigned int l; &#x2F;&#x2F; [esp+34h] [ebp-74h]</span><br><span class=\"line\">  char v13[100]; &#x2F;&#x2F; [esp+38h] [ebp-70h]</span><br><span class=\"line\">  unsigned int v14; &#x2F;&#x2F; [esp+9Ch] [ebp-Ch]</span><br><span class=\"line\">  v14 &#x3D; __readgsdword(0x14u);</span><br><span class=\"line\">  setvbuf(stdin, 0, 2, 0);</span><br><span class=\"line\">  setvbuf(stdout, 0, 2, 0);</span><br><span class=\"line\">  v9 &#x3D; 0;</span><br><span class=\"line\">  puts(&quot;***********************************************************&quot;);</span><br><span class=\"line\">  puts(&quot;*                      An easy calc                       *&quot;);</span><br><span class=\"line\">  puts(&quot;*Give me your numbers and I will return to you an average *&quot;);</span><br><span class=\"line\">  puts(&quot;*(0 &lt;&#x3D; x &lt; 256)                                           *&quot;);</span><br><span class=\"line\">  puts(&quot;***********************************************************&quot;);</span><br><span class=\"line\">  puts(&quot;How many numbers you have:&quot;);</span><br><span class=\"line\">  __isoc99_scanf(&quot;%d&quot;, &amp;v5);</span><br><span class=\"line\">  puts(&quot;Give me your numbers&quot;);</span><br><span class=\"line\">  for (i &#x3D; 0; i &lt; v5 &amp;&amp; (signed int)i &lt;&#x3D; 0x63; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    __isoc99_scanf(&quot;%d&quot;, &amp;v7);</span><br><span class=\"line\">    v13[i] &#x3D; v7;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  for (j &#x3D; v5; ; printf(&quot;average is %.2lf\\n&quot;, (double)((long double)v9 &#x2F; (double)j)) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    while (1)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      while (1)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        while (1)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          puts(&quot;1. show numbers\\n2. add number\\n3. change number\\n4. get average\\n5. exit&quot;);</span><br><span class=\"line\">          __isoc99_scanf(&quot;%d&quot;, &amp;v6);</span><br><span class=\"line\">          if (v6 !&#x3D; 2)</span><br><span class=\"line\">            break;</span><br><span class=\"line\">          puts(&quot;Give me your number&quot;);</span><br><span class=\"line\">          __isoc99_scanf(&quot;%d&quot;, &amp;v7);</span><br><span class=\"line\">          if (j &lt;&#x3D; 0x63)</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            v3 &#x3D; j++;</span><br><span class=\"line\">            v13[v3] &#x3D; v7;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if (v6 &gt; 2)</span><br><span class=\"line\">          break;</span><br><span class=\"line\">        if (v6 !&#x3D; 1)</span><br><span class=\"line\">          return 0;</span><br><span class=\"line\">        puts(&quot;id\\t\\tnumber&quot;);</span><br><span class=\"line\">        for (k &#x3D; 0; k &lt; j; ++k)</span><br><span class=\"line\">          printf(&quot;%d\\t\\t%d\\n&quot;, k, v13[k]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if (v6 !&#x3D; 3)</span><br><span class=\"line\">        break;</span><br><span class=\"line\">      puts(&quot;which number to change:&quot;);</span><br><span class=\"line\">      __isoc99_scanf(&quot;%d&quot;, &amp;v5);</span><br><span class=\"line\">      puts(&quot;new number:&quot;);</span><br><span class=\"line\">      __isoc99_scanf(&quot;%d&quot;, &amp;v7);</span><br><span class=\"line\">      v13[v5] &#x3D; v7;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (v6 !&#x3D; 4)</span><br><span class=\"line\">      break;</span><br><span class=\"line\">    v9 &#x3D; 0;</span><br><span class=\"line\">    for (l &#x3D; 0; l &lt; j; ++l)</span><br><span class=\"line\">      v9 +&#x3D; v13[l];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> 发现没有检查 v13 数组边界，当选择 3.change number 时程序没有对 v5 进行检测，存在数组越界，产生溢出：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">puts(&quot;which number to change:&quot;);</span><br><span class=\"line\">     __isoc99_scanf(&quot;%d&quot;, &amp;v5);</span><br><span class=\"line\">     puts(&quot;new number:&quot;);</span><br><span class=\"line\">     __isoc99_scanf(&quot;%d&quot;, &amp;v7);</span><br><span class=\"line\">     v13[v5] &#x3D; v7;</span><br></pre></td></tr></table></figure>\n\n<p> 发现给了 /bin/bash:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">:0804859B ; __unwind &#123;</span><br><span class=\"line\">.text:0804859B                 push    ebp</span><br><span class=\"line\">.text:0804859C                 mov     ebp, esp</span><br><span class=\"line\">.text:0804859E                 sub     esp, 18h</span><br><span class=\"line\">.text:080485A1                 mov     eax, large gs:14h</span><br><span class=\"line\">.text:080485A7                 mov     [ebp+var_C], eax</span><br><span class=\"line\">.text:080485AA                 xor     eax, eax</span><br><span class=\"line\">.text:080485AC                 sub     esp, 0Ch</span><br><span class=\"line\">.text:080485AF                 push    offset command  ; &quot;&#x2F;bin&#x2F;bash&quot;</span><br><span class=\"line\">.text:080485B4                 call    _system ;system</span><br><span class=\"line\">.text:080485B9                 add     esp, 10h</span><br><span class=\"line\">.text:080485BC                 nop</span><br><span class=\"line\">.text:080485BD                 mov     edx, [ebp+var_C]</span><br><span class=\"line\">.text:080485C0                 xor     edx, large gs:14h</span><br><span class=\"line\">.text:080485C7                 jz      short locret_80485CE</span><br><span class=\"line\">.text:080485C9                 call    ___stack_chk_fail</span><br></pre></td></tr></table></figure>\n\n<p> 开启动态调试，在 v13[v5]=v7 处下断点，</p>\n<p><img src=\"https://i.loli.net/2020/07/31/ClcWPX8p29JHxQk.png\" alt=\"linux 输入.PNG\"></p>\n<p> 转到 IDA 界面，查看此地址，此时 edx 存入的即为输入的数字 9，在栈中的位置是：</p>\n<p><img src=\"https://i.loli.net/2020/07/31/j24baYfNMdlRrGD.png\" alt=\"捕获.PNG\"></p>\n<p> 得到了输入在栈中的位置，找到返回地址的位置覆盖掉就可以了。</p>\n","url":"/posts/14181/","min2read":3,"word4post":664,"prev_post":{"title":"SQL 学习与整理","url":"/posts/11594/"},"next_post":{"title":"攻防世界 -dice_game","url":"/posts/3013/"},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"0x01- 分析\" href = \"#\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\">0x01 分析 </span></a></li></ol>","categories":[],"tags":[{"name":"pwn","path":"api/tags/pwn.json","url":"/tags/pwn/"}]}